# Прототип создания дампа базы данных средствами PHP

## Примечание
Данный функционал был протестирован с MySQL 8.0.20

## Настройка проекта
1. Настройте подключение к БД через файл .env в корне проекта
1. `сomposer install`  
1. `npm install && npm run prod`  

## Принцип работы:  

В процессе дампа используются классы:  
App\Backup\Dumpers\MySQLDump - содержит логику формирования дампа.   
App\Backup\DumpFile - запись данных в файл.  
App\Backup\DumpState - хранит состояние процесса, хранится в сессии.  
App\Backup\TableState - хранит состояние таблицы  

Пользователю при входе на главную страницу предлагается создать дамп БД.
При согласии будет произведен переход на страницу создания дампа `/dump`. 
Контроллер этой страницы вызывает метод *dump* класса *MySQLDump* который и начинает процесс бэкапа.
Данный метод возвращает значения:
- `true` - успешное завершение дампа, выдается ссылка на скачивание файла.
- `false` - в процессе.

**Примечание**: Пришлось отказать от прямого редиректа контроллера на самого себя. Причина в том, что браузер начинает выдавать ошибку *TOO MANY REDIRECTS* через определенное время, причем процесс дампа продолжается. Поэтому решено было использовать аттрибут `<meta http-equiv="refresh" content="0">` чтобы браузер сам инициализировал запрос к контроллеру.

Сам процесс разделен на шаги:
- Шаг 0: создание файла, блокировка таблиц, переопределение системных переменных
- Шаг 1: получение информации по таблицам/представлениям, кол-во строк
- Шаг 2: создание описания создание/удаления таблиц, представлений
- Шаг 3: получение и обработка данных
- Шаг 4: создание описания создание/удаления процедур, триггеров
- Шаг 5: разблокировка таблиц, восстановление системных переменных, очищение информации по дампу

На каждом шаге производится проверка времени жизни скрипта.
Как только время подходит к концу, сохраняются данные и выдается статистика клиенту. Далее браузер заново отправляет запрос на тот же адрес.

Чтобы не нагружать файловую систему, на шаге 3, данные записываются по достижении минимального кол-ва строк, которое задается константой `MIN_ROWS_TO_WRITE` в классе MySQLDump.
